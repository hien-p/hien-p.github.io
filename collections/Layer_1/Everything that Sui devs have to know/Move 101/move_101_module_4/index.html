<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><link href=https://hien-p.github.io/hari-docs/collections/Layer_1/Everything%20that%20Sui%20devs%20have%20to%20know/Move%20101/move_101_module_4/ rel=canonical><link rel="shortcut icon" href=../../../../../img/favicon.ico><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"><title>N·ªôi dung cho Module 4 - move 101 - Harry's Blog</title><link href=../../../../../css/bootstrap-3.3.7.min.css rel=stylesheet><link href=../../../../../css/font-awesome-4.7.0.css rel=stylesheet><link href=../../../../../css/base.css rel=stylesheet><link rel=stylesheet href=../../../../../css/highlight.css><link href=../../../../../css/custom.css rel=stylesheet><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]--><!-- mkdocs_windmill/partials/scripts.html --><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-S5RMPC6VZL"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S5RMPC6VZL');
</script><script src=../../../../../js/jquery-3.2.1.min.js></script><script src=../../../../../js/bootstrap-3.3.7.min.js></script><script src=../../../../../js/highlight.pack.js></script><base target=_top><script>
      var base_url = '../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "N\u1ed9i dung cho Module 4 - move 101", url: "#_top", children: [
          ]},
          {title: "Objective", url: "#objective", children: [
          ]},
          {title: "Common Patterns to Watch Out for When Programming in Sui Move", url: "#common-patterns-to-watch-out-for-when-programming-in-sui-move", children: [
          ]},
          {title: "Don\u2019t give a struct too many abilities; only assign the necessary ones", url: "#dont-give-a-struct-too-many-abilities-only-assign-the-necessary-ones", children: [
          ]},
          {title: "The metadata in Coin should be frozen", url: "#the-metadata-in-coin-should-be-frozen", children: [
          ]},
        ];

    </script><script src=../../../../../js/base.js></script><script src=../../../../../search/main.js></script><meta property=og:title content="Harry's Blog - Developer Documentation Technical Writer üöÄ"><meta property=og:description content="H·ªçc Blockchain d·ªÖ hi·ªÉu, d√†nh cho dev Web3"><meta property=og:image content=https://harriweb3.dev/assets/facebook_cover.png><meta property=og:type content=website><meta content=https://harriweb3.dev/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Harry's Blog - Developer Documentation Technical Writer üöÄ "><meta name=twitter:description content="H·ªçc Blockchain d·ªÖ hi·ªÉu, d√†nh cho dev Web3 m·ªõi v√†o ngh·ªÅ!"><meta name=twitter:image content=https://harriweb3.dev/assets/facebook_cover.png><link rel=stylesheet href=../../../../../css/extra.css></head> <body> <script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script> <div class="container-fluid wm-page-content"> <a name=_top></a> <div class="row wm-article-nav-buttons" role=navigation aria-label=navigation> <div class="wm-article-nav pull-right"> <a href=../../Move%20102/Sui%20Move%20standard%20library/Illustration%20of%20type%20name/ class="btn btn-xs btn-default pull-right"> Next <i class="fa fa-chevron-right" aria-hidden=true></i> </a> <a href=../../Move%20102/Sui%20Move%20standard%20library/Illustration%20of%20type%20name/ class="btn btn-xs btn-link"> Illustration of Sui Move standard library - type name (type_name) </a> </div> <div class=wm-article-nav> <a href=../move_101_module_3/ class="btn btn-xs btn-default pull-left"> <i class="fa fa-chevron-left" aria-hidden=true></i> Previous</a><a href=../move_101_module_3/ class="btn btn-xs btn-link"> Advanced Smart Contract ‚Äì Modules, Entry Functions &amp; Practice </a> </div> </div> <h1 id=noi-dung-cho-module-4-move-101>N·ªôi dung cho Module 4 - move 101<a class=headerlink href=#noi-dung-cho-module-4-move-101 title="Permanent link">&para;</a></h1> <h1 id=objective>Objective<a class=headerlink href=#objective title="Permanent link">&para;</a></h1> <ul> <li> <p>Gi·ªõi thi·ªáu c√°c pattern ph·ªï bi·∫øn trong Sui Move. V√≠ d·ª•: capability pattern, module-based access control, event emission pattern.</p> </li> <li> <p>H·ªçc c√°ch t√≠ch h·ª£p nhi·ªÅu module v√† qu·∫£n l√Ω c√°c t∆∞∆°ng t√°c ph·ª©c t·∫°p gi·ªØa object</p> </li> </ul> <h1 id=common-patterns-to-watch-out-for-when-programming-in-sui-move>Common Patterns to Watch Out for When Programming in Sui Move<a class=headerlink href=#common-patterns-to-watch-out-for-when-programming-in-sui-move title="Permanent link">&para;</a></h1> <p>Whether you‚Äôre building DeFi apps or other protocols on Sui, it‚Äôs crucial to perform rigorous security audits and thorough code testing during development‚Äîor before launching on Mainnet. Below are some common patterns that developers should be aware of.</p> <h1 id=dont-give-a-struct-too-many-abilities-only-assign-the-necessary-ones>Don‚Äôt give a struct too many abilities; only assign the necessary ones<a class=headerlink href=#dont-give-a-struct-too-many-abilities-only-assign-the-necessary-ones title="Permanent link">&para;</a></h1> <p>When defining custom structs in Move, it‚Äôs best not to grant overly broad abilities.</p> <p>That means you should first think about <strong>how the object will be used and assign it only the essential abilities to avoid unintended actions.</strong></p> <p><strong>Over-assigning abilities in event structs</strong></p> <p>For example, in <code>sui::event</code>, the <code>event</code> parameter only requires the copy and drop abilities‚Äîno more are needed.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>module sui::event {
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    public native fun emit&lt;T: copy + drop&gt;(event: T);
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>}
</span></code></pre></div> <p>Consider the following struct, which serves as a parameter for events to hold key information. In this case, the <code>store</code> ability is unnecessary and can be omitted.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>  /// Emitted when a new pool is created
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>  public struct PoolCreated has copy, store, drop {
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>      /// object ID of the newly created pool
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>      pool_id: ID,
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>      token_x_name: TypeName,
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>      token_y_name: TypeName,
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>  }
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>/// Emit the PoolCreated event
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>event::emit(PoolCreated { ‚Ä¶ });
</span></code></pre></div> <blockquote> <p>Suggestion: By removing the store ability, we can bring the struct in line with best practices.</p> </blockquote> <div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>/// Emitted when a new pool is created
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>struct PoolCreated has copy, drop {
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    /// object ID of the newly created pool
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>    pool_id: ID,
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    token_x_name: TypeName,
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>    token_y_name: TypeName,
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>}
</span></code></pre></div> <p><strong>Flashloan Struct</strong> Kh√¥ng n√™n c·∫•p qu√° nhi·ªÅu abilities. ƒê√¢y l√† snippet t·ª´ m·ªôt smart contract c√≥ feature flash loan: -&gt; loan() ‚Üí cho user m∆∞·ª£n m·ªôt l∆∞·ª£ng t√†i s·∫£n l·ªõn m√† kh√¥ng c·∫ßn collateral -&gt; repay() ‚Üí user tr·∫£ l·∫°i kho·∫£n vay</p> <p>Nguy√™n t·∫Øc khi tri·ªÉn <strong>khai flash loan tr√™n Sui l√†</strong> struct d√πng ƒë·ªÉ track kho·∫£n vay kh√¥ng ƒë∆∞·ª£c c√≥ abilities g√¨ c·∫£. T·∫°i sao? V√¨ struct n√†y ƒë∆∞·ª£c t·∫°o ·ªü method n√†y v√† destroyed ·ªü method kh√°c, v√† t·∫•t c·∫£ ph·∫£i xong trong m·ªôt transaction duy nh·∫•t.</p> <p>Nh√¨n v√†o v√≠ d·ª• d∆∞·ªõi ƒë√¢y, Receipt struct b·ªã g√°n th·ª´a abilities: store + drop. Sai l·∫ßm n√†y c√≥ th·ªÉ khi·∫øn repay() b·ªã b·ªè qua, v√† k·∫øt qu·∫£ l√† t√†i s·∫£n user m∆∞·ª£n c√≥ th·ªÉ kh√¥ng bao gi·ªù ƒë∆∞·ª£c tr·∫£ l·∫°i </p> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>/// A shared object offering flash loans to any buyer willing to pay `fee`.
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>struct FlashLender&lt;phantom T&gt; has key {
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    id: UID,
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    /// Coins available to be lent to prospective borrowers
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    to_lend: Balance&lt;T&gt;,
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    /// Number of `Coin&lt;T&gt;`&#39;s that will be charged for the loan.
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    /// In practice, this would probably be a percentage, but
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    /// we use a flat fee here for simplicity.
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    fee: u64,
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>}
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>struct Receipt&lt;phantom T&gt; has store, drop {
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>    /// ID of the flash lender object the debt holder borrowed from
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>    flash_lender_id: ID,
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>    /// Total amount of funds the borrower must repay: amount borrowed + the fee
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>    repay_amount: u64
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>}
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>/// Request a loan of `amount` from `lender`. The returned `Receipt&lt;T&gt;` &quot;hot potato&quot; ensures
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>/// that the borrower will call `repay(lender, ...)` later on in this tx.
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>/// Aborts if `amount` is greater that the amount that `lender` has available for lending.
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>public fun loan&lt;T&gt;(
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>    self: &amp;mut FlashLender&lt;T&gt;, amount: u64, ctx: &amp;mut TxContext
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>): (Coin&lt;T&gt;, Receipt&lt;T&gt;) {
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>let to_lend = &amp;mut self.to_lend;
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>    assert!(balance::value(to_lend) &gt;= amount, ELoanTooLarge);
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>    let loan = coin::take(to_lend, amount, ctx);
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>    let repay_amount = amount + self.fee;
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>    let receipt = Receipt { flash_lender_id: object::id(self), repay_amount };
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a>    (loan, receipt)
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a>}
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>/// Repay the loan recorded by `receipt` to `lender` with `payment`.
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a>/// Aborts if the repayment amount is incorrect or `lender` is not the `FlashLender`
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a>/// that issued the original loan.
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a>public fun repay&lt;T&gt;(self: &amp;mut FlashLender&lt;T&gt;, payment: Coin&lt;T&gt;, receipt: Receipt&lt;T&gt;) {
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a>    let Receipt { flash_lender_id, repay_amount } = receipt;
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a>    assert!(object::id(self) == flash_lender_id, ERepayToWrongLender);
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a>    assert!(coin::value(&amp;payment) == repay_amount, EInvalidRepaymentAmount);
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a>    coin::put(&amp;mut self.to_lend, payment)
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a>}
</span></code></pre></div> <blockquote> <p>Solution: Remove Excess Abilities from Receipt Struct</p> </blockquote> <p>To fix the issue, simply remove the store and drop abilities from the Receipt struct. The corrected struct should look like this:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>struct Receipt&lt;phantom T&gt; {
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    /// ID of the flash lender object the debt holder borrowed from
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    flash_lender_id: ID,
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>    /// Total amount of funds the borrower must repay: amount borrowed + the fee
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>    repay_amount: u64,
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>}
</span></code></pre></div> <p>Now, the struct has no extra abilities, ensuring the flash loan logic is safe: it is created and destroyed within the same transaction, and users cannot bypass repay().</p> <h1 id=the-metadata-in-coin-should-be-frozen>The metadata in Coin should be frozen<a class=headerlink href=#the-metadata-in-coin-should-be-frozen title="Permanent link">&para;</a></h1> <br> <div class="row wm-article-nav-buttons" role=navigation aria-label=navigation> <div class="wm-article-nav pull-right"> <a href=../../Move%20102/Sui%20Move%20standard%20library/Illustration%20of%20type%20name/ class="btn btn-xs btn-default pull-right"> Next <i class="fa fa-chevron-right" aria-hidden=true></i> </a> <a href=../../Move%20102/Sui%20Move%20standard%20library/Illustration%20of%20type%20name/ class="btn btn-xs btn-link"> Illustration of Sui Move standard library - type name (type_name) </a> </div> <div class=wm-article-nav> <a href=../move_101_module_3/ class="btn btn-xs btn-default pull-left"> <i class="fa fa-chevron-left" aria-hidden=true></i> Previous</a><a href=../move_101_module_3/ class="btn btn-xs btn-link"> Advanced Smart Contract ‚Äì Modules, Entry Functions &amp; Practice </a> </div> </div> <br> </div> <div class=giscus-wrapper> <div class=giscus></div> <script src=https://giscus.app/client.js data-repo=hien-p/hari-docs data-repo-id=R_kgDOPQrn9w data-category=Announcements data-category-id=DIC_kwDOPQrn984CtVCd data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async>
  </script> </div> <!-- <footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer> --> </body> </html>